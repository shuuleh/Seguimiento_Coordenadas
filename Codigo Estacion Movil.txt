#include "TinyGPS++.h"

TinyGPSPlus gps;

// ---- SIM800L en Serial 3 ----
// TX SIM800L → RX3 (pin 15)
// RX SIM800L → TX3 (pin 14)
HardwareSerial &SIM = Serial3;

// ---- GPS en Serial 2 ----
// TX GPS → RX2 (pin 17)
// RX GPS → TX2 (pin 16)

String smsNumero = "";
String smsTexto  = "";
bool esperandoTexto = false;

// Prototipo
void updateSerial(int wait = 500);
void enviarSMS(String numero, String texto);
String generarTextoGPS();

void setup() {
  Serial.begin(9600);

  // GPS
  Serial2.begin(9600);

  // SIM800
  SIM.begin(9600);
  delay(1000);

  Serial.println("===== INICIANDO SISTEMA GPS + SIM800 =====");

  // Configurar SIM800
  SIM.println("AT");
  updateSerial(1500);

  SIM.println("AT+CMGF=1");       // modo texto
  updateSerial();

  SIM.println("AT+CNMI=1,2,0,0,0");  // notificación instantánea
  updateSerial();

  Serial.println("Sistema listo. Esperando SMS...");
}

void loop() {

  // ==== 1. PROCESAR GPS EN SEGUNDO PLANO ====
  while (Serial2.available()) {
    gps.encode(Serial2.read());
  }

  // ==== 2. PROCESAR ENTRADA DEL SIM800 ====
  while (SIM.available()) {
    char c = SIM.read();
    Serial.write(c);

    static String linea = "";

    if (c == '\n') {
      linea.trim();

      // Detecta línea con el número
      if (linea.startsWith("+CMT:")) {

        int p1 = linea.indexOf("\"");
        int p2 = linea.indexOf("\"", p1 + 1);

        if (p1 != -1 && p2 != -1) {
          smsNumero = linea.substring(p1 + 1, p2);
          Serial.println("NUMERO DETECTADO: " + smsNumero);
        }

        esperandoTexto = true;
      }

      // La línea siguiente es el cuerpo del SMS
      else if (esperandoTexto) {

        smsTexto = linea;
        smsTexto.trim();
        smsTexto.toLowerCase();

        Serial.println("TEXTO RECIBIDO: " + smsTexto);
        esperandoTexto = false;

        // --- Si el SMS dice "enviar", mandar la posición ---
        if (smsTexto == "enviar") {
          Serial.println("ENVIANDO UBICACION...");
          enviarSMS(smsNumero, generarTextoGPS());
        }
      }

      linea = "";
    } else {
      linea += c;
    }
  }
}


// =============================================================
//  FUNCIONES
// =============================================================

String generarTextoGPS() {
  String msg = "";

  if (gps.location.isValid()) {
    msg += "Lat: ";
    msg += String(gps.location.lat(), 6);
    msg += "\nLon: ";
    msg += String(gps.location.lng(), 6);
    msg += "\nSat: ";
    msg += String(gps.satellites.value());
    msg += "\nAlt(m): ";
    msg += String(gps.altitude.meters());
    msg += "\nVel(km/h): ";
    msg += String(gps.speed.kmph());
  }
  else {
    msg += "Sin FIX. Satelites: ";
    msg += String(gps.satellites.value());
  }

  return msg;
}

void enviarSMS(String numero, String texto) {
  SIM.print("AT+CMGS=\"");
  SIM.print(numero);
  SIM.println("\"");

  updateSerial(1500);

  SIM.print(texto);

  updateSerial(200);

  SIM.write(26);  // Ctrl+Z terminar SMS
  Serial.println("SMS ENVIADO");

  updateSerial(3000);
}

void updateSerial(int wait) {
  delay(wait);
  while (SIM.available()) {
    Serial.write(SIM.read());
  }
}